# Azure Pipeline: Deploy Security Stack
# Deploys KMS, Secrets Manager, IAM Roles, and Lambda rotation functions
# Trigger: Manual only (security team responsibility)
#
# ⚠️ PREREQUISITES BEFORE RUNNING THIS PIPELINE:
#
# 1. AWS Service Connection:
#    - Name: 'aws-litellm-connection'
#    - Type: AWS
#    - Authentication: Access Key
#    - Setup: See docs/SETUP-AZURE-DEVOPS-DETAILED.md
#    - Required IAM permissions: KMS, SecretsManager, IAM, Lambda
#
# 2. Variable Group: 'litellm-aws-config'
#    Required variables:
#    - AWS_ACCOUNT_ID: Your AWS account ID
#    - AWS_REGION: AWS region (default: us-east-1)
#
# 3. This is the FIRST stack to deploy (no dependencies)
#    - Creates KMS keys for encryption
#    - Creates Secrets Manager secrets (with auto-generated passwords)
#    - Creates IAM roles for ECS, RDS, Lambda
#    - Creates Lambda functions for secret rotation
#

trigger: none

parameters:
- name: environment
  displayName: 'Environment to deploy to'
  type: string
  default: 'dev'
  values:
  - dev
  - staging
  - prod

- name: rotationDays
  displayName: 'Days between secret rotation'
  type: number
  default: 30

- name: awsRegion
  displayName: 'AWS Region'
  type: string
  default: 'us-east-1'


- name: costCenter
  displayName: 'Cost Center'
  type: string
  default: 'engineering'

- name: owner
  displayName: 'Owner (team or email)'
  type: string
  default: 'DevTeam'

- name: project
  displayName: 'Project Name'
  type: string
  default: 'litellm-proxy'

- name: compliance
  displayName: 'Compliance Classification'
  type: string
  default: 'None'
  values:
  - None
  - HIPAA
  - PCI
  - SOC2
  - GDPR

variables:
- group: litellm-aws-config
- name: stackName
  value: '${{ parameters.environment }}-security-stack'
- name: templateFile
  value: 'infrastructure/security-stack.yaml'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: DeploySecurityStack
  displayName: 'Deploy Security Stack'
  jobs:
  - job: Deploy
    displayName: 'Deploy Security Infrastructure'
    steps:
    - checkout: self
      displayName: 'Checkout repository'

    - template: templates/aws-cfn-deploy.yml
      parameters:
        stackName: '$(stackName)'
        templateFile: '$(templateFile)'
        parameters: 'Environment=${{ parameters.environment }} SecretRotationDays=${{ parameters.rotationDays }}'
        capabilities: 'CAPABILITY_NAMED_IAM'
        awsRegion: '${{ parameters.awsRegion }}'
        awsServiceConnection: 'aws-litellm-connection'
        tags: 'Environment=${{ parameters.environment }} Application=litellm ManagedBy=CloudFormation Owner=SecurityTeam'

    - task: AWSShellScript@1
      displayName: 'Get Stack Outputs and Display Summary'
      inputs:
        awsCredentials: 'aws-litellm-connection'
        regionName: '${{ parameters.awsRegion }}'
        scriptType: 'inline'
        inlineScript: |
          echo "=========================================="
          echo "Security Stack Deployed Successfully"
          echo "=========================================="
          echo ""
          echo "Environment: ${{ parameters.environment }}"
          echo ""

          STACK_NAME="$(stackName)"

          # Get KMS Key ARN
          KMS_KEY=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='KMSKeyArn'].OutputValue" \
            --output text)
          echo "KMS Key: $KMS_KEY"

          # Get Master Key Secret ARN
          MASTER_KEY_ARN=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='MasterKeySecretArn'].OutputValue" \
            --output text)
          echo "Master Key Secret: $MASTER_KEY_ARN"

          # Get API Keys Secret ARN
          API_KEYS_ARN=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='ApiKeysSecretArn'].OutputValue" \
            --output text)
          echo "API Keys Secret: $API_KEYS_ARN"

          # Get Database Secret ARN
          DB_SECRET_ARN=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='DatabaseSecretArn'].OutputValue" \
            --output text)
          echo "Database Secret: $DB_SECRET_ARN"

          # Get ECS Task Execution Role ARN
          TASK_EXEC_ROLE=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='ECSTaskExecutionRoleArn'].OutputValue" \
            --output text)
          echo "ECS Task Execution Role: $TASK_EXEC_ROLE"

          # Get ECS Task Role ARN
          TASK_ROLE=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='ECSTaskRoleArn'].OutputValue" \
            --output text)
          echo "ECS Task Role: $TASK_ROLE"

          echo ""
          echo "=========================================="
          echo "Next Steps:"
          echo "=========================================="
          echo "1. Update API Keys in Secrets Manager with real values:"
          echo "   aws secretsmanager update-secret --secret-id $API_KEYS_ARN --secret-string '{\"OPENAI_API_KEY\":\"sk-...\",\"ANTHROPIC_API_KEY\":\"sk-ant-...\"}'"
          echo ""
          echo "2. Deploy Network Stack:"
          echo "   az pipelines run --name azure-pipelines-network --parameters environment=${{ parameters.environment }}"
          echo ""
          echo "=========================================="
        failOnStderr: false
