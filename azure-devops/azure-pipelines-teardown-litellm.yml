# Azure Pipeline: Teardown LiteLLM Stack
# Deletes: ECS service, task definitions, ECR repository, CloudWatch logs

trigger: none

parameters:
- name: environment
  displayName: 'Environment'
  type: string
  default: 'dev'
  values:
  - dev
  - staging
  - prod

- name: awsRegion
  displayName: 'AWS Region'
  type: string
  default: 'us-east-1'

- name: confirmDelete
  displayName: 'Type DELETE to confirm'
  type: string
  default: ''

- name: deleteEcrImages
  displayName: 'Delete ECR images?'
  type: string
  default: 'false'
  values:
  - 'true'
  - 'false'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: litellm-aws-config
  - group: litellm-aws-secrets

stages:
- stage: Validate
  displayName: 'Validate Deletion'
  jobs:
  - job: ValidateConfirmation
    displayName: 'Validate Confirmation'
    steps:
    - checkout: none

    - bash: |
        if [ "${{ parameters.confirmDelete }}" != "DELETE" ]; then
          echo "❌ Confirmation failed"
          echo "You must type 'DELETE' to confirm stack deletion"
          exit 1
        fi
        echo "✓ Deletion confirmed"
      displayName: 'Confirm deletion'

- stage: TeardownLiteLLM
  displayName: 'Teardown LiteLLM Stack'
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - job: DeleteLiteLLM
    displayName: 'Delete LiteLLM Stack'
    steps:
    - checkout: none

    - task: AWSShellScript@1
      displayName: 'Delete LiteLLM Stack'
      inputs:
        awsCredentials: 'aws-litellm-connection'
        regionName: '${{ parameters.awsRegion }}'
        scriptType: 'inline'
        inlineScript: |
          STACK_NAME="${{ parameters.environment }}-litellm-stack"

          echo "=========================================="
          echo "Deleting LiteLLM Stack"
          echo "=========================================="
          echo "Stack Name: $STACK_NAME"
          echo "Region: ${{ parameters.awsRegion }}"
          echo "=========================================="

          if aws cloudformation describe-stacks --stack-name $STACK_NAME 2>/dev/null; then
            echo "Stack exists, proceeding with deletion..."

            # Get stack resources for cleanup verification
            echo ""
            echo "Stack resources to be deleted:"
            aws cloudformation list-stack-resources \
              --stack-name $STACK_NAME \
              --query 'StackResourceSummaries[*].[ResourceType,LogicalResourceId]' \
              --output table

            # Get ECS cluster and service details
            CLUSTER_NAME=$(aws cloudformation describe-stacks \
              --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" \
              --output text 2>/dev/null)

            SERVICE_NAME=$(aws cloudformation describe-stacks \
              --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?OutputKey=='ServiceName'].OutputValue" \
              --output text 2>/dev/null)

            if [ -n "$CLUSTER_NAME" ] && [ -n "$SERVICE_NAME" ]; then
              echo ""
              echo "ECS Service detected: $SERVICE_NAME in cluster $CLUSTER_NAME"
              echo "Scaling service to 0 tasks for faster deletion..."

              aws ecs update-service \
                --cluster $CLUSTER_NAME \
                --service $SERVICE_NAME \
                --desired-count 0 \
                --region ${{ parameters.awsRegion }} >/dev/null 2>&1 || true

              echo "Waiting for tasks to stop..."
              sleep 15
            fi

            # Delete the stack
            echo ""
            echo "Initiating stack deletion..."
            aws cloudformation delete-stack --stack-name $STACK_NAME

            # Wait for deletion to complete
            echo "Waiting for stack deletion to complete..."
            echo "(This typically takes 3-5 minutes)"
            aws cloudformation wait stack-delete-complete \
              --stack-name $STACK_NAME \
              --region ${{ parameters.awsRegion }}

            echo ""
            echo "=========================================="
            echo "✓ $STACK_NAME deleted successfully"
            echo "=========================================="

            # Handle ECR images if requested
            if [ "${{ parameters.deleteEcrImages }}" = "true" ]; then
              echo ""
              echo "Deleting ECR images..."

              ECR_REPO="litellm-proxy"
              IMAGE_IDS=$(aws ecr list-images \
                --repository-name $ECR_REPO \
                --query 'imageIds[*]' \
                --output json 2>/dev/null)

              if [ -n "$IMAGE_IDS" ] && [ "$IMAGE_IDS" != "[]" ]; then
                echo "Deleting images from repository: $ECR_REPO"
                aws ecr batch-delete-image \
                  --repository-name $ECR_REPO \
                  --image-ids "$IMAGE_IDS" \
                  --region ${{ parameters.awsRegion }} >/dev/null 2>&1 || true
                echo "✓ ECR images deleted"
              else
                echo "No images found in repository"
              fi
            else
              echo ""
              echo "⚠️  Note: ECR images retained"
              echo "To delete ECR images, re-run with 'deleteEcrImages=true'"
            fi

            # Verify deletion
            echo ""
            echo "Verifying cleanup..."

            # Check for orphaned ECS clusters
            CLUSTERS=$(aws ecs list-clusters \
              --query "clusterArns[?contains(@, '${{ parameters.environment }}-litellm')]" \
              --output text 2>/dev/null)

            if [ -n "$CLUSTERS" ]; then
              echo "⚠️  Warning: Found orphaned ECS clusters"
              echo "These should be manually cleaned up if not in use"
            else
              echo "✓ No orphaned ECS clusters found"
            fi

            # Check for orphaned task definitions
            TASK_FAMILIES=$(aws ecs list-task-definition-families \
              --family-prefix ${{ parameters.environment }}-litellm \
              --query 'families[*]' \
              --output text 2>/dev/null)

            if [ -n "$TASK_FAMILIES" ]; then
              echo "⚠️  Note: Found task definition families: $TASK_FAMILIES"
              echo "Task definitions are retained but inactive"
              echo "No charges apply for inactive task definitions"
            else
              echo "✓ No task definition families found"
            fi

            # Check for CloudWatch log groups
            LOG_GROUPS=$(aws logs describe-log-groups \
              --log-group-name-prefix /ecs/${{ parameters.environment }}-litellm \
              --query 'logGroups[*].logGroupName' \
              --output text 2>/dev/null)

            if [ -n "$LOG_GROUPS" ]; then
              echo "⚠️  Note: Found CloudWatch log groups"
              echo "Logs are retained for troubleshooting"
              echo "Delete manually if no longer needed to avoid storage charges"
            else
              echo "✓ No CloudWatch log groups found"
            fi

          else
            echo "Stack $STACK_NAME does not exist"
            echo "Nothing to delete"
          fi
        failOnStderr: false
        timeoutInMinutes: 15

    - bash: |
        echo ""
        echo "=========================================="
        echo "LiteLLM Stack Teardown Complete"
        echo "=========================================="
        echo ""
        echo "Deleted resources:"
        echo "  - ECS cluster and service"
        echo "  - ECS task definitions"
        echo "  - Application Auto Scaling targets"
        echo "  - IAM task execution role"
        echo "  - Security groups"
        echo "  - CloudWatch alarms"
        echo ""
        if [ "${{ parameters.deleteEcrImages }}" = "true" ]; then
          echo "  - ECR container images (deleted)"
        else
          echo "  - ECR container images (retained)"
        fi
        echo ""
        echo "Important notes:"
        echo "  - ECR repository structure retained"
        echo "  - CloudWatch logs may be retained"
        echo "  - Task definitions remain but are inactive"
        echo ""
        echo "Next steps:"
        echo "  - Database, ALB, Network, and Security stacks can now be torn down"
        echo ""
      displayName: 'Teardown summary'
